import requests
import json
import time
import datetime
from progressbar import progressbar 

BASE_URL = 'https://services.nvd.nist.gov/rest/json'
INPUT_FILE = 'components.json'
RESULTS_FILE = 'results.json'

def main():
    components = json.loads(open(INPUT_FILE).read())['components']
    results_dict = {
        'scanType': 'NIST vulnerability check',
        'dateRun': f'{datetime.datetime.now()}',
        'results': []
    }
    
    for component in progressbar(components, prefix='Checking components for vulenrabilities: '):
        cpe = requests.get(f'{BASE_URL}/cpes/2.0?cpeMatchString={component["cpe"]}').json()
        cve = requests.get(f'{BASE_URL}/cves/2.0?cpeName={component["cpe"]}').json()
        title = ''
        if cpe['totalResults']!=0:
            title = cpe['products'][0]['cpe']['titles'][0]['title']
        vulnerabilities = cve['vulnerabilities']
        
    
        component_result = {
            'name': component['name'],
            'version': component['version'],
            'title': title,
            'foundCPE':  False if cpe['totalResults']==0 else True,
            'vulnerabilityCount': len(vulnerabilities),
            'vulnerabilities': []
        }

        for vulnerability in vulnerabilities:
            component_result['vulnerabilities'].append({
                'id': vulnerability['cve']['id'],
                'status': vulnerability['cve']['vulnStatus'],
                'published': vulnerability['cve']['published'],
                'description': vulnerability['cve']['descriptions'][0]['value']
            })

        results_dict['results'].append(component_result)
        time.sleep(10)

    with open(RESULTS_FILE, 'w') as results_file:
        json.dump(results_dict, results_file)

if __name__ == '__main__':
    main()